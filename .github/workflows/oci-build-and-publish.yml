name: OCI Image Build

on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
    paths:
      - ".github/workflows/oci-build-and-publish.yml"
      - "images/**"
      - "resources/**"
  pull_request:
    branches: [ "main" ]
  workflow_dispatch: {}

env:
  IMAGE_TAG: v0.3.54   # default, override if needed

jobs:

  build-comfy:
    # The type of runner that the job will run on
    runs-on:
      group: homelab
      labels: ghar-scale-set
    container:
      image: ocr.jcan.dev/dh/alpine/curl:latest
    steps:
      - name: Extract ComfyUI submodule branch as OCI_IMAGE_TAG
        id: get_tag
        run: |
          # Extract the branch from .gitmodules (e.g. "v0.3.54")
          TAG=$(grep -A2 'resources/comfyui"' .gitmodules | grep branch | awk -F'= ' '{print $2}')
          echo "OCI_IMAGE_TAG=$TAG" >> $GITHUB_ENV
          echo "Using OCI_IMAGE_TAG=$TAG"

      # NOTE: unless rootless containers become compatible with GitHub-hosted runners,
      #   stick with Argo Workflow delegation for now.
      - name: Delegate build process to Argo Workflow
        run: |
          curl 'https://wf.jcan.dev/wf/webhooks/buildkit' \
          -H 'Content-Type: application/json' \
          -H 'Authorization: ${{ secrets.ARGOWF_BEARER_TOKEN }}' \
          -d '{
              "repo": "${{ github.repository }}",
              "branch": "main",
              "dockerfile": "images/${{ env.OCI_IMAGE_NAME }}",
              "image": "ocr.jcan.dev/library/sd-${{ env.OCI_IMAGE_NAME }}:${{ env.OCI_IMAGE_TAG }}",
              "context": "./"
            }'
      
        env:
          OCI_REGISTRY: ocr.jcan.dev/library
          OCI_IMAGE_NAME: comfyui
          CI_PROJECT_NAME: ${{ github.repository }}

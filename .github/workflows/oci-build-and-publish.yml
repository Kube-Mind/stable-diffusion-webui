name: OCI Image Build

on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch: {}

env:
  IMAGE_TAG: 0.0.1   # default, override if needed

jobs:

  build-comfy:
    # The type of runner that the job will run on
    runs-on:
      group: homelab
      labels: ghar-scale-set
    container:
      image: ocr.jcan.dev/dh/alpine/curl:latest
    steps:

      # NOTE: unless rootless containers become compatible with GitHub-hosted runners,
      #   stick with Argo Workflow delegation for now.
      - name: Delegate build process to Argo Workflow
        run: |
          curl 'https://wf.jcan.dev/wf/webhooks/buildkit' \
          -H 'Content-Type: application/json' \
          -H 'Authorization: ${{ secrets.ARGOWF_BEARER_TOKEN }} \
          -d '{
              "repo": ${{ github.repository }},
              "branch": "main",
              "dockerfile": "images/${{ env.OCI_IMAGE_NAME }}",
              "image": "ocr.jcan.dev/library/sdwui-${{ env.OCI_IMAGE_NAME }}:${{ env.IMAGE_TAG }}",
              "context": "./"
            }'
      
        env:
          OCI_REGISTRY: ocr.jcan.dev/library
          OCI_IMAGE_NAME: comfyui
          CI_PROJECT_NAME: ${{ github.repository }}

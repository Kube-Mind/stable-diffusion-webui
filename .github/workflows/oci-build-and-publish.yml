name: OCI Image Build

on:
  push:
    branches: [ "main" ]
    paths:
      - ".github/workflows/oci-build-and-publish.yml"
      - "images/**"
      - "resources/**"
      - "submodules.json"
  pull_request:
    branches: [ "main" ]
    paths:
      - ".github/workflows/oci-build-and-publish.yml"
      - "images/**"
      - "resources/**"
      - "submodules.json"
  workflow_dispatch: {}

env:
  OCI_REGISTRY: ocr.jcan.dev/library
  OCI_IMAGE_NAME: comfyui   # maps to "comfyui" key in submodules.json

jobs:
  build-comfy:
    runs-on:
      group: homelab
      labels: ghar-scale-set
    container:
      image: ghcr.io/actions/actions-runner:2.328.0
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Delegate build process to Argo Workflow
        run: |
          # Trigger ArgoWF delegation script
          chmod u+x tools/scripts/trigger-build.sh
          ./tools/scripts/trigger-build.sh ${{ secrets.ARGOWF_BEARER_TOKEN }}
